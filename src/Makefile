# where is the AMD_APP Toolkit installed?
AMD_APP_DIR = ../../../AMD-APP-SDK-v2.4-lnx64
AMD_APP_INCLUDE = -I$(AMD_APP_DIR)/include
AMD_APP_LIB = -L$(AMD_APP_DIR)/lib/x86_64

# optimize or debug
OPTIMIZE_FLAG = -O2
# OPTIMIZE_FLAG = -g

# Compiler settings for .c files (CPU)
CC = gcc
CFLAGS = -Wall $(OPTIMIZE_FLAG) $(AMD_APP_INCLUDE) -DBUILD_OPENCL
CFLAGS_EXTRA_SIEVE = -funroll-all-loops

# Linker
LD = g++
LDFLAGS = $(AMD_APP_LIB) -lOpenCL

##############################################################################

CSRC  = sieve.c timer.c parse.c read_config.c mfaktc.c checkpoint.c \
	signal_handler.c 
CLSRC = mfakto_Kernels.cl barrett.cl

COBJS  = $(CSRC:.c=.o) mfakto.o

##############################################################################

all: ../mfakto ../barrett.cl ../mfakto_Kernels.cl

../mfakto : $(COBJS)
	$(LD) $^ $(LDFLAGS) -o $@

clean :
	rm -f *.o *~

sieve.o : sieve.c
	$(CC) $(CFLAGS) $(CFLAGS_EXTRA_SIEVE) -c $< -o $@
	
%.o : %.c
	$(CC) $(CFLAGS) -c $< -o $@

%.o : %.cpp
	$(CC) $(CFLAGS) $(CPP_FLAGS) -c $< -o $@

../%.cl : %.cl
	cp $< ..

##############################################################################

# dependencies generated by cpp -MM (manually replaced AMD_APP_DIR)
#
checkpoint.o: checkpoint.c params.h

mfaktc.o: mfaktc.c $(AMD_APP_DIR)/include/CL/cl.h \
 $(AMD_APP_DIR)/include/CL/cl_platform.h params.h \
 my_types.h compatibility.h sieve.h read_config.h parse.h timer.h \
 checkpoint.h signal_handler.h mfakto.h selftest-data.h

parse.o: parse.c compatibility.h

read_config.o: read_config.c params.h my_types.h

sieve.o: sieve.c params.h compatibility.h

signal_handler.o: signal_handler.c params.h my_types.h compatibility.h

timer.o: timer.c timer.h compatibility.h

mfakto.o: mfakto.cpp $(AMD_APP_DIR)/include/CL/cl.h \
 $(AMD_APP_DIR)/include/CL/cl_platform.h params.h \
 my_types.h compatibility.h read_config.h parse.h sieve.h timer.h \
 checkpoint.h mfakto.h
