# This file is part of mfaktc (mfakto).
# Copyright (C) 2009 - 2011  Oliver Weihe (o.weihe@t-online.de)
#                            Bertram Franz (bertramf@gmx.net)
# 
# mfaktc (mfakto) is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# mfaktc (mfakto) is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#                                 
# You should have received a copy of the GNU General Public License
# along with mfaktc (mfakto).  If not, see <http://www.gnu.org/licenses/>.
# 
#  Version 0.13
# 
# where is the AMD_APP Toolkit installed?
AMD_APP_DIR = /opt/AMDAPP
AMD_APP_INCLUDE = -I$(AMD_APP_DIR)/include
AMD_APP_LIB = -L$(AMD_APP_DIR)/lib/x86_64

# optimize or debug
#OPTIMIZE_FLAG = -O3
#OPTIMIZE_FLAG = -O3 -funroll-loops  -finline-functions -frerun-loop-opt -fgcse-sm -fgcse-las 
#OPTIMIZE_FLAG = -O3 -funroll-loops  -ffast-math -finline-functions -frerun-loop-opt -fgcse-sm -fgcse-las -flto
OPTIMIZE_FLAG = -g

# Compiler settings for .c files (CPU)
CC = gcc
CPP = $(CC)
CFLAGS = -Wall $(OPTIMIZE_FLAG) $(AMD_APP_INCLUDE) -DBUILD_OPENCL
CPP_FLAGS =
#CFLAGS_EXTRA_SIEVE = -funroll-all-loops 
#CFLAGS_EXTRA_SIEVE = -funroll-all-loops -funsafe-loop-optimizations -fira-region=all -fsched-spec-load -fsched-stalled-insns=10 -fsched-stalled-insns-dep=10 -floop-parallelize-all -fvariable-expansion-in-unroller -fno-align-labels 
CFLAGS_EXTRA_SIEVE = -funroll-all-loops -funsafe-loop-optimizations -fira-region=all -fsched-spec-load -fsched-stalled-insns=10 -fsched-stalled-insns-dep=10 -fno-align-labels 


# Linker
LD = g++
LDFLAGS = $(OPTIMIZE_FLAG) $(AMD_APP_LIB) -lOpenCL

##############################################################################

CSRC  = sieve.c timer.c parse.c read_config.c mfaktc.c checkpoint.c \
	signal_handler.c filelocking.c output.c
CLSRC = mfakto_Kernels.cl barrett.cl barrett15.cl barrett24.cl mul24.cl sieve.cl

COBJS  = $(CSRC:.c=.o) mfakto.o gpusieve.o perftest.o

##############################################################################

all: ../mfakto ../barrett.cl ../mfakto_Kernels.cl ../montgomery.cl ../mul24.cl ../gpusieve.cl ../barrett24.cl ../barrett15.cl ../datatypes.h ../tf_debug.h

../mfakto : $(COBJS)
	$(LD) $^ $(LDFLAGS) -o $@

clean :
	rm -f *.o *~

sieve.o : sieve.c
	$(CC) $(CFLAGS) $(CFLAGS_EXTRA_SIEVE) -c $< -o $@
	
%.o : %.c
	$(CC) $(CFLAGS) -c $< -o $@

%.o : %.cpp
	$(CPP) $(CFLAGS) $(CPP_FLAGS) -c $< -o $@

../%.cl : %.cl
	cp $< ..

../%.h : %.h
	cp $< ..

##############################################################################

# dependencies generated by cpp -MM (manually replaced AMD_APP_DIR)
#

checkpoint.o: checkpoint.c params.h timer.h

filelocking.o: filelocking.c

mfaktc.o: mfaktc.c $(AMD_APP_DIR)/include/CL/cl.h \
 $(AMD_APP_DIR)/include/CL/cl_platform.h params.h my_types.h compatibility.h \
 sieve.h read_config.h parse.h timer.h checkpoint.h signal_handler.h \
 filelocking.h perftest.h mfakto.h gpusieve.h output.h selftest-data.h

output.o: output.c params.h my_types.h $(AMD_APP_DIR)/include/CL/cl.h \
 $(AMD_APP_DIR)/include/CL/cl_platform.h output.h filelocking.h \
 compatibility.h

parse.o: parse.c compatibility.h filelocking.h parse.h

read_config.o: read_config.c params.h my_types.h \
 $(AMD_APP_DIR)/include/CL/cl.h $(AMD_APP_DIR)/include/CL/cl_platform.h

sieve.o: sieve.c params.h compatibility.h

signal_handler.o: signal_handler.c params.h my_types.h \
 $(AMD_APP_DIR)/include/CL/cl.h $(AMD_APP_DIR)/include/CL/cl_platform.h \
 compatibility.h

timer.o: timer.c timer.h compatibility.h

gpusieve.o: gpusieve.cpp $(AMD_APP_DIR)/include/CL/cl.h \
 $(AMD_APP_DIR)/include/CL/cl_platform.h my_types.h params.h compatibility.h

mfakto.o: mfakto.cpp $(AMD_APP_DIR)/include/CL/cl.h \
 $(AMD_APP_DIR)/include/CL/cl_platform.h params.h my_types.h compatibility.h \
 read_config.h parse.h sieve.h timer.h checkpoint.h filelocking.h \
 perftest.h mfakto.h output.h gpusieve.h signal_handler.h

perftest.o: perftest.cpp $(AMD_APP_DIR)/include/CL/cl.h \
 $(AMD_APP_DIR)/include/CL/cl_platform.h params.h my_types.h compatibility.h \
 read_config.h parse.h sieve.h timer.h checkpoint.h filelocking.h \
 signal_handler.h mfakto.h
